<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hey fam</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* --- DARK MODE CONFIG --- */
      :root {
        --insta-bg: #000000;
        --insta-gray: #262626;
        --insta-blue: #0095f6;
        --msg-received: #262626;
        --msg-sent: #3797f0;
        --text-main: #f5f5f5;
        --time-text: #8e8e8e;
      }
      body {
        background-color: var(--insta-bg);
        color: var(--text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }
      .chat-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--insta-bg); }
      header { background: var(--insta-bg); border-bottom: 1px solid var(--insta-gray); padding: 10px 20px; z-index: 10; }
      .header-main h3 { margin: 0; font-size: 16px; font-weight: 600; text-align: center; padding-bottom: 10px; }
      #activeList { display: flex; gap: 15px; padding: 5px 0; overflow-x: auto; scrollbar-width: none; }
      #activeList::-webkit-scrollbar { display: none; }
      .user-status { display: flex; flex-direction: column; align-items: center; position: relative; min-width: 60px; transition: opacity 0.5s ease; }
      .avatar-circle { width: 48px; height: 48px; border-radius: 50%; padding: 2px; margin-bottom: 4px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); position: relative; }
      .avatar-inner { width: 100%; height: 100%; background: var(--insta-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; }
      .status-dot { height: 13px; width: 13px; background-color: #1ed760; border: 2px solid var(--insta-bg); border-radius: 50%; position: absolute; bottom: 22px; right: 8px; z-index: 2; }
      .username-label { font-size: 11px; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .user-status.idle { opacity: 0.5; }
      .user-status.idle .status-dot { background-color: #ffcc00; }
      .zzz-overlay { position: absolute; top: -5px; right: 0px; font-size: 20px; animation: floatZ 2s infinite ease-in-out; display: none; z-index: 10; text-shadow: 1px 1px 2px black; }
      .user-status.idle .zzz-overlay { display: block; }
      @keyframes floatZ { 0%, 100% { transform: translate(0, 0) scale(0.8); opacity: 0.7; } 50% { transform: translate(2px, -3px) scale(1.1); opacity: 1; } }
      #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; overflow-x: hidden; }
      .time-separator { text-align: center; color: var(--time-text); font-size: 12px; font-weight: 500; margin: 20px 0 10px 0; }
      .message-row { display: flex; width: 100%; position: relative; margin-bottom: 5px; }
      .message-row.sent { justify-content: flex-end; }
      .message-row.received { justify-content: flex-start; }
      .message { padding: 12px 18px; border-radius: 22px; max-width: 65%; font-size: 15px; line-height: 1.5; word-wrap: break-word; position: relative; cursor: grab; user-select: none; touch-action: pan-y; transform: translateX(0); will-change: transform; display: flex; flex-direction: column; z-index: 2; }
      .sent .message { background-color: var(--msg-sent); color: white; border-bottom-right-radius: 4px; }
      .received .message { background-color: var(--msg-received); border-bottom-left-radius: 4px; }
      .message a { text-decoration: underline; word-break: break-all; cursor: pointer; }
      .sent .message a { color: white; }
      .received .message a { color: #e0f1ff; }
      .text-content { display: inline-block; transition: font-size 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: left center; }
      .scream { font-size: 2.2em; font-weight: 800; animation: shakeScream 0.8s both; }
      @keyframes shakeScream { 0%, 100% { transform: translate(0,0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-2px, -2px); } 20%, 40%, 60%, 80% { transform: translate(2px, 2px); } }
      .sender-tag { font-size: 11px; font-weight: 600; margin-bottom: 4px; opacity: 0.7; color: #aaa; margin-left: 10px; }
      .chat-image { max-width: 100%; max-height: 400px; border-radius: 12px; margin-top: 5px; display: block; }
      .heart-badge { position: absolute; bottom: -10px; background: #262626; border: 2px solid #000; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; align-items: center; justify-content: center; transform: scale(0); transition: transform 0.2s; z-index: 5; }
      .heart-badge.visible { transform: scale(1); }
      .sent .heart-badge { left: -8px; }
      .received .heart-badge { right: -8px; }
      .reply-quote-block { background-color: rgba(0, 0, 0, 0.2); border-left: 3px solid rgba(255, 255, 255, 0.5); padding: 8px 10px; border-radius: 8px; margin-bottom: 6px; font-size: 13px; display: flex; flex-direction: column; pointer-events: none; }
      #replyPreviewBar { background-color: #1e1e1e; padding: 10px 20px; border-top: 1px solid var(--insta-gray); display: none; justify-content: space-between; align-items: center; }
      .input-area { padding: 20px; border-top: 1px solid var(--insta-gray); display: flex; align-items: center; gap: 15px; background: var(--insta-bg); }
      .icon-btn { background: none; border: none; color: var(--text-main); font-size: 24px; cursor: pointer; }
      #msgInput { flex: 1; padding: 14px 24px; border: 1px solid var(--insta-gray); border-radius: 30px; background: #262626; color: white; outline: none; }
      #sendBtn { color: var(--insta-blue); background: none; border: none; font-weight: 600; font-size: 16px; cursor: pointer; }
      #cameraOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
      #cameraVideo { width: 100%; max-height: 80vh; object-fit: cover; }
      .camera-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; align-items: center; }
      #snapBtn { width: 70px; height: 70px; background: white; border-radius: 50%; border: 4px solid #ccc; cursor: pointer; }
      #closeCameraBtn { color: white; background: rgba(0,0,0,0.5); border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
      #canvas { display: none; }
      #typingWrapper { display: none; flex-direction: column; margin-bottom: 10px; margin-left: 10px; }
      .dot { width: 6px; height: 6px; background-color: #888; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
      @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
      #seenIndicator { text-align: right; font-size: 11px; color: var(--time-text); margin-right: 10px; margin-bottom: 5px; display: none; }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <header>
        <div class="header-main"><h3>fams supersecret database</h3></div>
        <div id="activeList"></div>
      </header>
      <div id="messages"></div>
      <div id="seenIndicator">Seen</div>
      <div id="typingWrapper">
        <div class="typing-label" id="typingLabel">Someone is typing...</div>
        <div id="typingIndicator"><div style="display:flex;gap:4px;"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
      </div>
      <div id="replyPreviewBar">
        <div class="reply-info"><span class="replying-to-label" style="color:var(--insta-blue);font-weight:600;">Replying...</span><br><span id="replyPreviewText" style="color:#aaa;font-size:14px;"></span></div>
        <button id="cancelReplyBtn" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">&times;</button>
      </div>
      <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" hidden />
        <button id="fileBtn" class="icon-btn">üìé</button>
        <button id="cameraBtn" class="icon-btn">üì∑</button>
        <input type="text" id="msgInput" placeholder="Message..." autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div id="cameraOverlay">
      <video id="cameraVideo" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="camera-controls">
        <button id="closeCameraBtn">Cancel</button>
        <button id="snapBtn"></button>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://cmwvgjipwuxiaabxukcz.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtd3Znamlwd3V4aWFhYnh1a2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE5MDIsImV4cCI6MjA4NjkyNzkwMn0.JZm-pyFsmUVferdxKpdAbN_5Ex2qr0ODpSQGcaPNSC8";
      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentReplyData = null;
      let lastMessageTime = null;
      let cameraStream = null;
      let typingTimeout = null;
      let isTyping = false;
      let lastSentMessageTime = null;
      let myName = "";
      let userTimestamps = {};

      window.addEventListener("DOMContentLoaded", () => {
        myName = localStorage.getItem("chat-user") || prompt("Enter your name:") || "Guest";
        localStorage.setItem("chat-user", myName);

        const msgInput = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");
        const msgDiv = document.getElementById("messages");
        const activeListDiv = document.getElementById("activeList");
        const replyPreviewBar = document.getElementById("replyPreviewBar");
        const fileInput = document.getElementById("fileInput");
        const fileBtn = document.getElementById("fileBtn");
        const cameraBtn = document.getElementById("cameraBtn");
        const typingWrapper = document.getElementById("typingWrapper");
        const typingLabel = document.getElementById("typingLabel");
        const seenIndicator = document.getElementById("seenIndicator");
        const cameraOverlay = document.getElementById("cameraOverlay");
        const cameraVideo = document.getElementById("cameraVideo");
        const snapBtn = document.getElementById("snapBtn");
        const closeCameraBtn = document.getElementById("closeCameraBtn");
        const canvas = document.getElementById("canvas");

        msgDiv.appendChild(seenIndicator);
        msgDiv.appendChild(typingWrapper);

        function formatTime(dateObj) { return dateObj.toLocaleTimeString([], { weekday: "short", hour: "numeric", minute: "2-digit" }); }
        function linkify(text) {
          if (!text) return "";
          const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
          return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
        }

        async function updateMySeenStatus() {
          await _supabase.from("user_presence").upsert({ username: myName, last_seen: new Date().toISOString() });
        }

        async function checkStatusLoop() {
          const { data: users } = await _supabase.from("user_presence").select("*");
          if (users) {
            users.forEach(u => userTimestamps[u.username] = new Date(u.last_seen));
            if (lastSentMessageTime) {
              const other = users.find(u => u.username !== myName);
              if (other && new Date(other.last_seen) > new Date(lastSentMessageTime)) {
                seenIndicator.style.display = "block";
              }
            }
          }
          renderActiveList();
        }
        setInterval(checkStatusLoop, 5000);

        function renderActiveList() {
          const state = presenceChannel.presenceState();
          const onlineUsers = Object.keys(state);
          activeListDiv.innerHTML = onlineUsers.map(name => {
            const isIdle = userTimestamps[name] && (new Date() - userTimestamps[name]) > 180000;
            return `<div class="user-status ${isIdle ? 'idle' : ''}"><div class="avatar-circle"><div class="avatar-inner">${name[0].toUpperCase()}</div></div><div class="zzz-overlay">üí§</div><span class="status-dot"></span><span class="username-label">${name === myName ? 'You' : name}</span></div>`;
          }).join("");
        }

        function renderMessage(data) {
          if (document.getElementById(`msg-${data.id}`)) return;
          const isMe = data.sender === myName;
          const row = document.createElement("div");
          row.className = `message-row ${isMe ? 'sent' : 'received'}`;
          row.id = `msg-${data.id}`;
          const div = document.createElement("div");
          div.className = "message";
          
          let content = data.message_type === "image" 
            ? `<img src="${data.image_url}" class="chat-image" />`
            : `<div class="text-content">${linkify(data.content)}</div>`;
          
          div.innerHTML = `${!isMe ? `<span class="sender-tag">${data.sender}</span>`:''} ${content}<div class="heart-badge">‚ù§Ô∏è</div>`;
          row.appendChild(div);
          msgDiv.insertBefore(row, seenIndicator);
          msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        async function uploadAndSendImage(fileBlob) {
          if (!fileBlob) return;
          msgInput.placeholder = "Uploading...";
          const fileName = `${Date.now()}.jpg`;
          const { error } = await _supabase.storage.from("chat-images").upload(fileName, fileBlob);
          if (!error) {
            const { data: urlData } = _supabase.storage.from("chat-images").getPublicUrl(fileName);
            await _supabase.from("messages").insert([{ sender: myName, message_type: "image", image_url: urlData.publicUrl, content: "üì∑ Image" }]);
          }
          msgInput.placeholder = "Message...";
        }

        // --- CAMERA CONTROLS FIXED ---
        cameraBtn.onclick = async () => {
          try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
            cameraVideo.srcObject = cameraStream;
            cameraOverlay.style.display = "flex";
          } catch (err) { alert("Camera access denied."); }
        };

        function stopCamera() {
          if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
          cameraOverlay.style.display = "none";
        }

        snapBtn.onclick = () => {
          canvas.width = cameraVideo.videoWidth;
          canvas.height = cameraVideo.videoHeight;
          canvas.getContext("2d").drawImage(cameraVideo, 0, 0);
          canvas.toBlob(blob => { stopCamera(); uploadAndSendImage(blob); }, "image/jpeg", 0.8);
        };

        closeCameraBtn.onclick = stopCamera;
        fileBtn.onclick = () => fileInput.click();
        fileInput.onchange = (e) => uploadAndSendImage(e.target.files[0]);

        async function sendMessage() {
          const val = msgInput.value.trim();
          if (!val) return;
          msgInput.value = "";
          await _supabase.from("messages").insert([{ content: val, sender: myName, message_type: "text" }]);
        }

        sendBtn.onclick = sendMessage;
        msgInput.onkeydown = (e) => { if(e.key === "Enter") sendMessage(); };

        const presenceChannel = _supabase.channel("online-users", { config: { presence: { key: myName } } });
        presenceChannel.on("presence", { event: "sync" }, renderActiveList).subscribe(async (s) => {
          if (s === "SUBSCRIBED") await presenceChannel.track({ online_at: new Date().toISOString() });
        });

        _supabase.channel("chat-room").on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => renderMessage(payload.new)).subscribe();

        _supabase.from("messages").select("*").order("created_at", { ascending: true }).then(({data}) => data && data.forEach(renderMessage));
      });
    </script>
  </body>
</html>
