<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hey fam</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --insta-bg: #000000;
            --insta-gray: #262626;
            --insta-blue: #0095f6;
            --msg-received: #262626;
            --msg-sent: #3797f0;
            --text-main: #f5f5f5;
        }
        body { background: var(--insta-bg); color: var(--text-main); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .message-row { display: flex; width: 100%; margin-bottom: 4px; }
        .message-row.sent { justify-content: flex-end; }
        .message { padding: 10px 15px; border-radius: 20px; max-width: 70%; font-size: 15px; position: relative; }
        .sent .message { background: var(--msg-sent); border-bottom-right-radius: 4px; }
        .received .message { background: var(--msg-received); border-bottom-left-radius: 4px; }
        .chat-image { max-width: 100%; border-radius: 12px; display: block; margin-top: 5px; }
        .input-area { padding: 15px; border-top: 1px solid var(--insta-gray); display: flex; align-items: center; gap: 10px; background: #000; }
        #msgInput { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid var(--insta-gray); background: #262626; color: #fff; outline: none; }
        .icon-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: white; }
        #cameraOverlay { position: fixed; inset: 0; background: #000; z-index: 100; display: none; flex-direction: column; align-items: center; }
        #cameraVideo { width: 100%; height: 80%; object-fit: cover; }
        .cam-btns { position: absolute; bottom: 40px; display: flex; gap: 30px; }
        #snapBtn { width: 70px; height: 70px; border-radius: 50%; border: 5px solid #fff; background: transparent; }
        #canvas { display: none; }
    </style>
</head>
<body>

    <div id="messages"></div>

    <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" hidden />
        <button id="fileBtn" class="icon-btn">ðŸ“Ž</button>
        <button id="cameraBtn" class="icon-btn">ðŸ“·</button>
        <input type="text" id="msgInput" placeholder="Message..." autocomplete="off" />
        <button id="sendBtn" style="color:var(--insta-blue); background:none; border:none; font-weight:bold;">Send</button>
    </div>

    <div id="cameraOverlay">
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="cam-btns">
            <button id="closeCameraBtn" class="icon-btn">âœ•</button>
            <button id="snapBtn"></button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://cmwvgjipwuxiaabxukcz.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtd3Znamlwd3V4aWFhYnh1a2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE5MDIsImV4cCI6MjA4NjkyNzkwMn0.JZm-pyFsmUVferdxKpdAbN_5Ex2qr0ODpSQGcaPNSC8";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myName = localStorage.getItem("chat-user") || prompt("Enter Name:") || "Guest";
        localStorage.setItem("chat-user", myName);

        const msgDiv = document.getElementById("messages");
        const msgInput = document.getElementById("msgInput");
        const cameraOverlay = document.getElementById("cameraOverlay");
        const cameraVideo = document.getElementById("cameraVideo");
        const canvas = document.getElementById("canvas");
        let cameraStream = null;

        function renderMessage(data) {
            if (document.getElementById(`msg-${data.id}`)) return;
            const isMe = data.sender === myName;
            const row = document.createElement("div");
            row.className = `message-row ${isMe ? 'sent' : 'received'}`;
            row.id = `msg-${data.id}`;
            
            let content = data.message_type === "image" 
                ? `<img src="${data.image_url}" class="chat-image" />`
                : `<div>${data.content}</div>`;

            row.innerHTML = `<div class="message">${isMe ? '' : '<small style="color:#888">'+data.sender+'</small><br>'}${content}</div>`;
            msgDiv.appendChild(row);
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        async function uploadAndSend(blob) {
            const fileName = `${Date.now()}.jpg`;
            msgInput.placeholder = "Uploading...";
            
            // 1. Upload to Storage
            const { error: storageError } = await _supabase.storage
                .from("chat-images")
                .upload(fileName, blob);

            if (storageError) {
                alert("Upload failed: " + storageError.message);
                return;
            }

            // 2. Get Public URL
            const { data: urlData } = _supabase.storage.from("chat-images").getPublicUrl(fileName);

            // 3. Insert into Database
            await _supabase.from("messages").insert([{
                sender: myName,
                content: "ðŸ“· Photo",
                message_type: "image",
                image_url: urlData.publicUrl
            }]);
            
            msgInput.placeholder = "Message...";
        }

        // --- CAMERA LOGIC ---
        document.getElementById("cameraBtn").onclick = async () => {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                cameraVideo.srcObject = cameraStream;
                cameraOverlay.style.display = "flex";
            } catch (e) { alert("Camera error: " + e.message); }
        };

        document.getElementById("closeCameraBtn").onclick = () => {
            if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
            cameraOverlay.style.display = "none";
        };

        document.getElementById("snapBtn").onclick = () => {
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            canvas.getContext("2d").drawImage(cameraVideo, 0, 0);
            
            canvas.toBlob((blob) => {
                if (blob) {
                    document.getElementById("closeCameraBtn").click(); // Stop camera
                    uploadAndSend(blob);
                }
            }, "image/jpeg", 0.8);
        };

        // --- GENERAL CHAT LOGIC ---
        document.getElementById("sendBtn").onclick = async () => {
            const val = msgInput.value.trim();
            if (!val) return;
            msgInput.value = "";
            await _supabase.from("messages").insert([{ content: val, sender: myName }]);
        };

        document.getElementById("fileBtn").onclick = () => document.getElementById("fileInput").click();
        document.getElementById("fileInput").onchange = (e) => uploadAndSend(e.target.files[0]);

        // Realtime Subscription
        _supabase.channel("room1").on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, p => renderMessage(p.new)).subscribe();

        // Load History
        _supabase.from("messages").select("*").order("created_at", { ascending: true }).then(({data}) => data && data.forEach(renderMessage));
    </script>
</body>
</html>
